!function(a,b,c,d){var e,f=d.media;f.view.l10n?e=f.view.l10n:(e=f.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n,delete e.settings),f.controller.EditAttachmentMetadata=f.controller.State.extend({defaults:{id:"edit-attachment",title:e.attachmentDetails,menu:!1,content:"edit-metadata",url:""},_ready:function(){},_postActivate:function(){this.frame.on("title:render:default",this._renderTitle,this),this._title(),this._content()},_title:function(){this.frame.title.render(this.get("titleMode")||"default")},_renderTitle:function(a){a.$el.text(this.get("title")||"")},_content:function(){var a=this.get("content");a&&this.frame.content.render(a)}}),f.view.MediaFrame.Manage=f.view.MediaFrame.extend({initialize:function(){var c=this;b.defaults(this.options,{title:"",modal:!1,selection:[],library:{},multiple:"add",state:"library",uploader:!0,mode:["grid","edit"]}),a(document).on("click",".add-new-h2",b.bind(this.addNewClickHandler,this)),a(document).on("screen:options:open",b.bind(this.screenOptionsOpen,this)),a(document).on("screen:options:close",b.bind(this.screenOptionsClose,this)),this.$el.addClass("wp-core-ui media-grid-view"),(d.Uploader.limitExceeded||!d.Uploader.browser.supported)&&(this.options.uploader=!1),this.options.uploader&&(this.uploader=new f.view.UploaderWindow({controller:this,uploader:{dropzone:a("body"),container:a("body")}}).render(),this.uploader.ready(),a("body").append(this.uploader.el),this.options.uploader=!1),f.view.MediaFrame.prototype.initialize.apply(this,arguments),this.$el.appendTo(this.options.container),this.createSelection(),this.createStates(),this.bindHandlers(),this.render(),a("#media-search-input").on("input",b.debounce(function(b){var d=a(b.currentTarget).val(),e="";d&&(e+="?search="+d),c.gridRouter.navigate(c.gridRouter.baseUrl(e))},1e3)),b.delay(b.bind(this.createRouter,this),1e3)},screenOptionsOpen:function(){this.$el.addClass("media-grid-view-options")},screenOptionsClose:function(){this.$el.removeClass("media-grid-view-options")},createRouter:function(){this.gridRouter=new f.view.MediaFrame.Manage.Router,window.history&&window.history.pushState&&c.history.start({root:_wpMediaGridSettings.adminUrl,pushState:!0})},createSelection:function(){var a=this.options.selection;a instanceof f.model.Selection||(this.options.selection=new f.model.Selection(a,{multiple:this.options.multiple})),this._selection={attachments:new f.model.Attachments,difference:[]}},createStates:function(){var a=this.options;this.options.states||this.states.add([new f.controller.Library({library:f.query(a.library),multiple:a.multiple,title:a.title,priority:20,router:!1,content:"browse",filterable:"mime-types"})])},bindHandlers:function(){this.on("content:create:browse",this.browseContent,this),this.on("content:render:edit-image",this.editImageContent,this),this.on("edit:attachment",this.editAttachment,this)},addNewClickHandler:function(a){a.preventDefault(),this.trigger("toggle:upload:attachment")},editAttachment:function(a){d.media({frame:"edit-attachments",gridRouter:this.gridRouter,library:this.state().get("library"),model:a})},browseContent:function(a){var b=this.state();a.view=new f.view.AttachmentsBrowser({controller:this,collection:b.get("library"),selection:b.get("selection"),model:b,sortable:b.get("sortable"),search:b.get("searchable"),filters:b.get("filterable"),display:b.get("displaySettings"),dragInfo:b.get("dragInfo"),sidebar:!1,suggestedWidth:b.get("suggestedWidth"),suggestedHeight:b.get("suggestedHeight"),AttachmentView:b.get("AttachmentView")})},editImageContent:function(){var a=this.state().get("image"),b=new f.view.EditImage({model:a,controller:this}).render();this.content.set(b),b.loadEditor()}}),f.view.Attachment.Details.TwoColumn=f.view.Attachment.Details.extend({template:d.template("attachment-details-two-column"),events:{"change [data-setting]":"updateSetting","change [data-setting] input":"updateSetting","change [data-setting] select":"updateSetting","change [data-setting] textarea":"updateSetting","click .delete-attachment":"deleteAttachment","click .trash-attachment":"trashAttachment","click .edit-attachment":"editAttachment","click .refresh-attachment":"refreshAttachment","click .edit-image":"handleEditImageClick"},initialize:function(){this.model&&(this.$el.attr("aria-label",this.model.get("title")).attr("aria-checked",!1),this.model.on("change:title",this._syncTitle,this),this.model.on("change:caption",this._syncCaption,this),this.model.on("change:percent",this.progress,this),this.model.on("change:album",this._syncAlbum,this),this.model.on("change:artist",this._syncArtist,this),this.model.on("add",this.select,this),this.model.on("remove",this.deselect,this),this.model.on("sync",this.afterDelete,this))},preDestroy:function(a){a.preventDefault(),this.lastIndex=this.controller.getCurrentIndex(),this.hasNext=this.controller.hasNext()},trashAttachment:function(a){this.preDestroy(a),f.view.Attachment.Details.prototype.trashAttachment.apply(this,arguments)},deleteAttachment:function(a){this.preDestroy(a),f.view.Attachment.Details.prototype.deleteAttachment.apply(this,arguments)},handleEditImageClick:function(){this.controller.setState("edit-image")},afterDelete:function(a){if(a.destroyed){var b=this.controller,c=this.lastIndex;if(!b.library.length)return void f.frame.modal.close();this.hasNext&&(c-=1),b.model=b.library.at(c),b.nextMediaItem()}},render:function(){f.view.Attachment.Details.prototype.render.apply(this,arguments),f.mixin.removeAllPlayers(),a("audio, video",this.$el).each(function(a,b){var c=f.view.MediaDetails.prepareSrc(b);new MediaElementPlayer(c,f.mixin.mejsSettings)})}}),f.view.MediaFrame.Manage.Router=c.Router.extend({routes:{"upload.php?item=:slug":"showitem","upload.php?search=:query":"search",":default":"defaultRoute"},baseUrl:function(a){return"upload.php"+a},search:function(b){this.closeModal(),a("#media-search-input").val(b).trigger("input")},showitem:function(a){var b=f.frame.state().get("library");this.closeModal(),f.frame.trigger("edit:attachment",b.findWhere({id:parseInt(a,10)}))},closeModal:function(){f.frame.modal&&f.frame.modal.close()},defaultRoute:function(){this.closeModal(),a("#media-search-input").val("").trigger("input")}}),f.view.MediaFrame.EditAttachments=f.view.MediaFrame.extend({className:"edit-attachment-frame",template:f.template("edit-attachment-frame"),regions:["title","content"],events:{click:"collapse","click .delete-media-item":"deleteMediaItem","click .left":"previousMediaItem","click .right":"nextMediaItem"},initialize:function(){var c=this;f.view.Frame.prototype.initialize.apply(this,arguments),b.defaults(this.options,{modal:!0,state:"edit-attachment"}),this.gridRouter=this.options.gridRouter,this.library=this.options.library,this.model=this.options.model?this.options.model:this.library.at(0),this.createStates(),this.on("content:render:edit-metadata",this.editMetadataContent,this),this.on("content:render:edit-image",this.editImageContentUgh,this),this.on("close",this.detach),this.on("title:create:default",this.createTitle,this),this.title.mode("default"),this.options.hasPrevious=this.hasPrevious(),this.options.hasNext=this.hasNext(),this.options.modal&&(this.modal=new f.view.Modal({controller:this,title:this.options.title}),this.modal.on("open",function(){a("body").on("keydown.media-modal",b.bind(c.keyEvent,c))}),this.modal.on("close",function(){c.modal.remove(),a("body").off("keydown.media-modal"),c.resetRoute()}),this.modal.content(this),this.modal.open())},createStates:function(){var a=new f.controller.EditImage({model:this.model});a._toolbar=function(){},a._router=function(){},a._menu=function(){},this.states.add([new f.controller.EditAttachmentMetadata({model:this.model}),a])},editMetadataContent:function(){var a=new f.view.Attachment.Details.TwoColumn({controller:this,model:this.model});this.content.set(a),this.model?this.gridRouter.navigate(this.gridRouter.baseUrl("?item="+this.model.id)):this.resetRoute()},editImageContentUgh:function(){b.defer(b.bind(this.editImageContent,this))},editImageContent:function(){var a=new f.view.EditImage({model:this.model,controller:this}).render();this.content.set(a),a.loadEditor()},resetContent:function(){this.modal.close(),d.media({frame:"edit-attachments",gridRouter:this.gridRouter,library:this.library,model:this.model})},previousMediaItem:function(){this.hasPrevious()&&(this.model=this.library.at(this.getCurrentIndex()-1),this.resetContent())},nextMediaItem:function(){this.hasNext()&&(this.model=this.library.at(this.getCurrentIndex()+1),this.resetContent())},getCurrentIndex:function(){return this.library.indexOf(this.model)},hasNext:function(){return this.getCurrentIndex()+1<this.library.length},hasPrevious:function(){return this.getCurrentIndex()-1>-1},keyEvent:function(b){var c=a(b.target);return 27===b.keyCode?(this.resetRoute(),b):c.is("input")||c.is("textarea")?b:(39===b.keyCode&&this.nextMediaItem(),void(37===b.keyCode&&this.previousMediaItem()))},resetRoute:function(){this.gridRouter.navigate(this.gridRouter.baseUrl(""))}}),f.view.BulkSelection=f.View.extend({className:"bulk-select",initialize:function(){this.model=new c.Model({currentAction:""}),this.views.add(new f.view.BulkSelectionActionDropdown({controller:this})),this.views.add(new f.view.BulkSelectionActionButton({disabled:!0,text:e.apply,controller:this}))}}),f.view.BulkSelectionActionDropdown=f.View.extend({tagName:"select",initialize:function(){f.view.Button.prototype.initialize.apply(this,arguments),this.listenTo(this.controller.controller.state().get("selection"),"add remove reset",b.bind(this.enabled,this)),this.$el.append(a("<option></option>").val("").html(e.bulkActions)).append(a("<option></option>").val("delete").html(e.deletePermanently)),this.$el.prop("disabled",!0),this.$el.on("change",b.bind(this.toggleChange,this))},toggleChange:function(){this.controller.model.set({currentAction:this.$el.val()})},enabled:function(){var a=!this.controller.controller.state().get("selection").length;this.$el.prop("disabled",a)}}),f.view.BulkSelectionActionButton=f.view.Button.extend({tagName:"button",initialize:function(){f.view.Button.prototype.initialize.apply(this,arguments),this.listenTo(this.controller.model,"change",this.enabled,this),this.listenTo(this.controller.controller.state().get("selection"),"add remove reset",b.bind(this.enabled,this))},click:function(){var a=this.controller.controller.state().get("selection");if(f.view.Button.prototype.click.apply(this,arguments),confirm(e.warnBulkDelete))for(;a.length>0;)a.at(0).destroy();this.enabled()},enabled:function(){var a=this.controller.model.get("currentAction"),b=this.controller.controller.state().get("selection"),c=!a||!b.length;this.$el.prop("disabled",c)}})}(jQuery,_,Backbone,wp);