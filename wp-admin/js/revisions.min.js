window.wp=window.wp||{};(function(b){var a;a=wp.revisions={model:{},view:{},controller:{},router:{}};a.settings=typeof _wpRevisionsSettings==="undefined"?{}:_wpRevisionsSettings;a.model.Slider=Backbone.Model.extend({defaults:{value:0,min:0,max:1,step:1}});a.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,position:0}});a.model.Revision=Backbone.Model.extend({});a.model.Revisions=Backbone.Collection.extend({model:a.model.Revision,comparator:function(c){return c.id}});a.model.Field=Backbone.Model.extend({});a.model.Fields=Backbone.Collection.extend({model:a.model.Field});a.model.Diff=Backbone.Model.extend({initialize:function(d,e){var c=this.get("fields");this.unset("fields");this.fields=new a.model.Fields(c)}});a.model.Diffs=Backbone.Collection.extend({initialize:function(d,c){this.revisions=c.revisions;this.requests={}},model:a.model.Diff,ensure:function(h,d){var g=this.get(h);var f=this.requests[h];var c=b.Deferred();var e={};if(g){c.resolveWith(d,[g])}else{this.trigger("ensure:load",e);_.each(e,_.bind(function(i){if(this.requests[i]){delete e[i]}},this));if(!f){e[h]=true;f=this.load(_.keys(e))}f.done(_.bind(function(){c.resolveWith(d,[this.get(h)])},this))}return c.promise()},loadNew:function(c){c=_.object(c,c);_.each(c,_.bind(function(d){if(this.get(d)){delete c[d]}},this));c=_.toArray(c);return this.load(c)},load:function(c){return this.fetch({data:{compare:c},remove:false})},loadLast:function(c){c=c||1;var d=this.getProximalDiffIds();d=_.last(d,c);if(d.length){return this.loadNew(d)}},loadLastUnloaded:function(c){c=c||1;var d=this.getUnloadedProximalDiffIds();d=_.last(d,c);if(d.length){return this.loadNew(d)}},getProximalDiffIds:function(){var d=0,c=[];this.revisions.each(_.bind(function(e){c.push(d+":"+e.id);d=e.id},this));return c},getUnloadedProximalDiffIds:function(){var c=this.getProximalDiffIds();c=_.object(c,c);_.each(c,_.bind(function(d){if(this.get(d)){delete c[d]}},this));return _.toArray(c)},loadAllBy:function(d){d=d||20;var c=this.getUnloadedProximalDiffIds();if(c.length){return this.loadLastUnloaded(d).always(_.bind(function(){this.loadAllBy(d)},this))}},sync:function(g,e,d){if("read"===g){d=d||{};d.context=this;d.data=_.extend(d.data||{},{action:"get-revision-diffs",post_id:a.settings.postId});var c=wp.xhr.send(d);var f=this.requests;if(d.data.compare){_.each(d.data.compare,function(h){f[h]=c})}c.always(function(){if(d.data.compare){_.each(d.data.compare,function(h){delete f[h]})}});return c}else{return Backbone.Model.prototype.sync.apply(this,arguments)}}});a.model.FrameState=Backbone.Model.extend({initialize:function(c,d){this.revisions=d.revisions;this.diffs=new a.model.Diffs([],{revisions:this.revisions});this.listenTo(this,"change:from",this.updateDiffFrom);this.listenTo(this,"change:to",this.updateDiffTo);this.revisionsRouter=new a.router.Router({model:this})},updateDiffTo:function(){var c=this.get("from");this.set("diffId",(c?c.id:"0")+":"+this.get("to").id)},updateDiffFrom:function(){if(this.get("compareTwoMode")){this.updateDiffTo()}}});a.view.Frame=wp.Backbone.View.extend({tagName:"div",className:"revisions",template:wp.template("revisions-frame"),initialize:function(){this.model=new a.model.FrameState({},{revisions:this.collection});this.listenTo(this.model,"change:diffId",this.updateDiff);this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode);this.views.set(".revisions-control-frame",new a.view.Controls({model:this.model}));if(this.model.revisions.length){var d=this.model.revisions.last(2);var c={to:d.pop()};if(d.length){c.from=d.pop()}this.model.set(c);this.model.diffs.loadLastUnloaded(10).always(_.bind(function(){this.model.diffs.loadAllBy(50)},this))}Backbone.history.start()},render:function(){wp.Backbone.View.prototype.render.apply(this,arguments);b("#wpbody-content .wrap").append(this.el);this.views.ready();return this},updateDiff:function(){this.model.diffs.ensure(this.model.get("diffId"),this).done(function(c){if(this.model.get("diffId")!==c.id){return}this.views.set(".revisions-diff-frame",new a.view.Diff({model:c}));this.model.trigger("renderDiff")})},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions")}});a.view.Controls=wp.Backbone.View.extend({tagName:"div",className:"revisions-controls",initialize:function(){this.views.add(new a.view.Buttons({model:this.model}));this.views.add(new a.view.Checkbox({model:this.model}));var c=new a.view.Tooltip({model:new a.model.Tooltip()});this.views.add(c);this.views.add(new a.view.Slider({model:this.model,tooltip:c}));this.views.add(new a.view.Meta({model:this.model}))}});a.view.Meta=wp.Backbone.View.extend({tagName:"div",className:"revisions-meta",template:wp.template("revisions-meta"),events:{"click #restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"change:diffId",this.updateMeta)},restoreRevision:function(){var c=this.model.get("to").attributes.restoreUrl.replace(/&amp;/g,"&");document.location=c},updateMeta:function(){this.$el.html(this.template(this.model.toJSON()));b("#restore-revision").prop("disabled",this.model.get("to").attributes.current)}});a.view.Checkbox=wp.Backbone.View.extend({tagName:"div",className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.$el.html(this.template())},updateCompareTwoMode:function(){if(this.model.get("compareTwoMode")){b(".compare-two-revisions").prop("checked",true);b(".wp-slider a.ui-slider-handle").first().addClass(isRtl?"right-handle":"left-handle");b(".wp-slider a.ui-slider-handle").last().addClass(isRtl?"left-handle":"right-handle")}else{b(".compare-two-revisions").prop("checked",false);b(".wp-slider a.ui-slider-handle").removeClass("left-handle").removeClass("right-handle")}},compareTwoToggle:function(c){this.model.set({compareTwoMode:b(".compare-two-revisions").prop("checked")});this.model.revisionsRouter.navigateRoute(this.model.get("to").id,this.model.get("from").id)},ready:function(){if(this.model.revisions.length<3){b(".revision-toggle-compare-mode").hide()}this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode);this.updateCompareTwoMode()}});a.view.Tooltip=wp.Backbone.View.extend({tagName:"div",className:"revisions-tooltip",template:wp.template("revisions-tooltip"),initialize:function(){this.listenTo(this.model,"change",this.render)},ready:function(){this.$el.addClass("hidden")},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")},render:function(){if(null===this.model.get("revision")){return}this.$el.html(this.template(this.model.get("revision").toJSON()));var c=b(".revisions-buttons").offset().left;this.$el.css("left",this.model.get("position")-c)}});a.view.Buttons=wp.Backbone.View.extend({tagName:"div",className:"revisions-buttons",template:wp.template("revisions-buttons"),events:{"click #next":"nextRevision","click #previous":"previousRevision"},initialize:function(){this.$el.html(this.template())},ready:function(){this.listenTo(this.model,"change:diffId",this.disabledButtonCheck)},gotoModel:function(d){var c={to:this.model.revisions.at(isRtl?this.model.revisions.length-d-1:d)};if(isRtl?this.model.revisions.length-d-1:d){c.from=this.model.revisions.at(isRtl?this.model.revisions.length-d-2:d-1)}else{this.model.unset("from",{silent:true})}this.model.set(c);this.model.revisionsRouter.navigateRoute(c.to.id,c.from?c.from.id:0)},nextRevision:function(){var c=isRtl?this.model.revisions.length-this.model.revisions.indexOf(this.model.get("to"))-1:this.model.revisions.indexOf(this.model.get("to"));c=isRtl?c-1:c+1;this.gotoModel(c)},previousRevision:function(){var c=isRtl?this.model.revisions.length-this.model.revisions.indexOf(this.model.get("to"))-1:this.model.revisions.indexOf(this.model.get("to"));c=isRtl?c+1:c-1;this.gotoModel(c)},disabledButtonCheck:function(){var g=this.model.revisions.length-1,c=0,d=b(".revisions-next .button"),e=b(".revisions-previous .button"),f=this.model.revisions.indexOf(this.model.get("to"));d.prop("disabled",(g===f));e.prop("disabled",(c===f))}});a.view.Slider=wp.Backbone.View.extend({tagName:"div",className:"wp-slider",events:{mousemove:"mousemove",mouseenter:"mouseenter",mouseleave:"mouseleave"},initialize:function(c){_.bindAll(this,"start","slide","stop");this.tooltip=c.tooltip;var d=this.model.revisions.length-1;var e=this.model.revisions.indexOf(this.model.revisions.findWhere({id:Number(a.settings.selectedRevision)}));this.settings=new a.model.Slider({max:d,value:e,start:this.start,slide:this.slide,stop:this.stop})},ready:function(){this.settings.attributes.value=this.model.revisions.indexOf(this.model.revisions.findWhere({id:Number(a.settings.selectedRevision)}));this.updateSliderSettings();this.slide("",this.settings.attributes);this.$el.slider(this.settings.toJSON());this.listenTo(this.model,"change:compareTwoMode",this.updateSliderSettings);this.settings.on("change",function(){this.updateSliderSettings()},this);this.listenTo(this.model,"change:diffId",this.diffIdChanged)},mousemove:function(i){var f=Math.ceil(this.$el.offset().left),d=Math.ceil(this.$el.width())+2,c=Math.ceil((d)/this.model.revisions.length),h=i.clientX-f,g=Math.floor(h/c);if(isRtl){g=this.model.revisions.length-g-1}if(g<0){g=0}else{if(g>=this.model.revisions.length){g=this.model.revisions.length-1}}this.tooltip.model.set("revision",this.model.revisions.at(g));this.tooltip.model.set("position",i.clientX)},mouseenter:function(c){this.tooltip.show()},mouseleave:function(c){this.tooltip.hide()},updateSliderSettings:function(){if(this.model.get("compareTwoMode")){var d,c;if("undefined"==typeof this.model.get("from")){if(isRtl){d=this.model.revisions.length-this.model.revisions.indexOf(this.model.get("to"))-2;c=d+1}else{d=this.model.revisions.indexOf(this.model.get("to"));c=d+1}}else{d=isRtl?this.model.revisions.length-this.model.revisions.indexOf(this.model.get("to"))-1:this.model.revisions.indexOf(this.model.get("from")),c=isRtl?this.model.revisions.length-this.model.revisions.indexOf(this.model.get("from"))-1:this.model.revisions.indexOf(this.model.get("to"))}this.$el.slider({values:[d,c],value:null,range:true})}else{this.$el.slider({value:isRtl?this.model.revisions.length-this.model.revisions.indexOf(this.model.get("to"))-1:this.model.revisions.indexOf(this.model.get("to")),values:null,range:false})}if(this.model.get("compareTwoMode")){b("a.ui-slider-handle",this.$el).first().addClass(isRtl?"right-handle":"left-handle").removeClass(isRtl?"left-handle":"right-handle");b("a.ui-slider-handle",this.$el).last().addClass(isRtl?"left-handle":"right-handle").removeClass(isRtl?"right-handle":"left-handle")}},diffIdChanged:function(){if(this.model.get("compareTwoMode")){this.settings.set({values:[this.model.revisions.indexOf(this.model.get("from")),this.model.revisions.indexOf(this.model.get("to"))]})}else{this.settings.set({value:this.model.revisions.indexOf(this.model.get("to"))})}},getSliderPosition:function(c){return isRtl?this.model.revisions.length-c.value-1:c.value},start:function(c,d){b(window).on("mousemove",{view:this},function(i){var j=i.data.view,n=j.$el.offset().left,f=n,g=n+j.$el.width(),l=g,m=0,o=g-f;if(j.model.get("compareTwoMode")){var k=b(d.handle).parent().find(".right-handle"),h=b(d.handle).parent().find(".left-handle");if(b(d.handle).hasClass("left-handle")){if(isRtl){n=k.offset().left+k.width();m=n-f}else{l=k.offset().left;o=l-f}}else{if(isRtl){l=h.offset().left;o=l-f}else{n=h.offset().left+h.width();m=n-f}}}if(i.clientX<n){b(d.handle).css("left",m)}else{if(i.clientX>l){b(d.handle).css("left",o)}else{b(d.handle).css("left",i.clientX-f)}}})},slide:function(e,f){var d;if("undefined"!==typeof f.values&&this.model.get("compareTwoMode")){if(f.values[1]===f.values[0]){return false}d={to:this.model.revisions.at(isRtl?this.model.revisions.length-f.values[0]-1:f.values[1]),from:this.model.revisions.at(isRtl?this.model.revisions.length-f.values[1]-1:f.values[0])}}else{var c=this.getSliderPosition(f);d={to:this.model.revisions.at(c)};if(c){d.from=this.model.revisions.at(c-1)}else{this.model.unset("from",{silent:true})}}this.model.set(d)},stop:function(c,d){b(window).off("mousemove");this.settings.trigger("change")}});a.view.Diff=wp.Backbone.View.extend({tagName:"div",className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},this.options)}});a.router.Router=Backbone.Router.extend({initialize:function(c){this.model=c.model;this.listenTo(this.model,"renderDiff",this.updateURL)},routes:{"revision/from/:from/to/:to/handles/:handles":"gotoRevisionId"},navigateRoute:function(e,d){var c="/revision/from/"+d+"/to/"+e+"/handles/";if(this.model.get("compareTwoMode")){c+="2"}else{c+="1"}this.navigate(c)},updateURL:_.debounce(function(){var c=this.model.get("from");this.navigateRoute(this.model.get("to").id,c?c.id:0)},250),gotoRevisionId:function(g,f,e){this.model.set({compareTwoMode:("2"===e)});if("undefined"!==typeof this.model){var d=this.model.revisions.findWhere({id:Number(f)}),c=this.model.revisions.findWhere({id:Number(g)});this.model.set({to:d,from:c})}a.settings.selectedRevision=f}});a.init=function(){a.view.frame=new a.view.Frame({collection:new a.model.Revisions(a.settings.revisionData)}).render()};b(a.init)}(jQuery));